{{- if eq .chezmoi.os "windows" -}}
# chezmoi run_onchange_ script — Claude Code hook 路徑修復（Windows only）
# 腳本內容改變時自動重新執行

$ErrorActionPreference = "Stop"
$pluginCache = Join-Path $env:USERPROFILE ".claude\plugins\cache"

# ── 修復 hook 路徑（backslash → cygpath workaround）────────────────────────
if (Test-Path $pluginCache) {
    $hooksFiles = Get-ChildItem -Path $pluginCache -Recurse -Filter "hooks.json" |
        Where-Object { $_.FullName -match "\\hooks\\hooks\.json$" }

    foreach ($file in $hooksFiles) {
        $content = Get-Content $file.FullName -Raw
        if ($content -match '\$\{CLAUDE_PLUGIN_ROOT\}/' -and $content -notmatch 'cygpath') {
            $lines = $content -split "`n"
            $result = @()
            foreach ($line in $lines) {
                if ($line -match '"command"\s*:\s*"\$\{CLAUDE_PLUGIN_ROOT\}/(.+)"' -and $line -notmatch 'cygpath') {
                    $scriptPath = $Matches[1]
                    $hasComma   = $line.TrimEnd().EndsWith(',')
                    $indent     = $line -replace '^(\s*).*', '$1'
                    $newCmd     = "bash -c 'FIXED_ROOT=`$(cygpath -u \`"`${CLAUDE_PLUGIN_ROOT}\`" 2>/dev/null || echo \`"`${CLAUDE_PLUGIN_ROOT}\`"); \`"`$FIXED_ROOT/$scriptPath\`"'"
                    $comma      = if ($hasComma) { ',' } else { '' }
                    $result    += "${indent}`"command`": `"$newCmd`"$comma"
                } else {
                    $result += $line
                }
            }
            $utf8NoBom = New-Object System.Text.UTF8Encoding $false
            [System.IO.File]::WriteAllText($file.FullName, ($result -join "`n"), $utf8NoBom)
            Write-Host "  Patched: $($file.FullName)" -ForegroundColor Gray
        }
    }
}

# ── 修復 .sh 腳本的 CRLF 問題 ────────────────────────────────────────────
if (Get-Command "dos2unix" -ErrorAction SilentlyContinue) {
    $shFiles = @(Get-ChildItem -Path $pluginCache -Recurse -Filter "*.sh" -ErrorAction SilentlyContinue)
    $ErrorActionPreference = "Continue"
    foreach ($file in $shFiles) { dos2unix $file.FullName 2>$null }
    $ErrorActionPreference = "Stop"
}

# ── 移除 hooks.json 的 UTF-8 BOM ─────────────────────────────────────────
if (Test-Path $pluginCache) {
    $hooksJsonFiles = @(Get-ChildItem -Path $pluginCache -Recurse -Filter "hooks.json" |
        Where-Object { $_.FullName -match "\\hooks\\hooks\.json$" })
    $utf8NoBom = New-Object System.Text.UTF8Encoding $false
    foreach ($file in $hooksJsonFiles) {
        $bytes = [System.IO.File]::ReadAllBytes($file.FullName)
        if ($bytes.Length -ge 3 -and $bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF) {
            $content = [System.Text.Encoding]::UTF8.GetString($bytes, 3, $bytes.Length - 3)
            [System.IO.File]::WriteAllText($file.FullName, $content, $utf8NoBom)
            Write-Host "  Fixed BOM: $($file.FullName)" -ForegroundColor Gray
        }
    }
}

Write-Host "Claude hook fixes complete." -ForegroundColor Green
{{ end -}}
